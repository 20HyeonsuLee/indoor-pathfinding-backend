name: Deploy Spring Boot

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy Spring Boot
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create storage directories
        run: |
          New-Item -ItemType Directory -Force -Path storage/maps
          New-Item -ItemType Directory -Force -Path storage/uploads
          New-Item -ItemType Directory -Force -Path storage/output
        shell: powershell

      - name: Build Spring Boot image
        run: docker compose build spring-app

      - name: Deploy Spring Boot
        run: docker compose up -d spring-app

      - name: Wait for startup
        run: Start-Sleep -Seconds 15
        shell: powershell

      - name: Health check
        run: |
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while ($retryCount -lt $maxRetries -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/v3/api-docs" -UseBasicParsing -TimeoutSec 10
              if ($response.StatusCode -eq 200) {
                Write-Host "Spring Boot is running successfully!"
                $success = $true
              }
            } catch {
              $retryCount++
              Write-Host "Attempt $retryCount/$maxRetries - Waiting for Spring Boot to start..."
              Start-Sleep -Seconds 10
            }
          }

          if (-not $success) {
            Write-Host "Spring Boot health check failed. Checking logs..."
            docker compose logs --tail=50 spring-app
            exit 1
          }
        shell: powershell

      - name: Show running containers
        if: always()
        run: docker compose ps
